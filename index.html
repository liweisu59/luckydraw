<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ephemeral Lucky Draw</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom modal styles */
        #modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #modal-content {
            transition: all 0.3s ease-in-out;
            transform: translateY(-20px);
        }
        body.modal-open #modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 space-y-8">
        
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Ephemeral Lucky Draw</h1>
            <p class="text-gray-400 mt-2">Submit a secret. Draw a secret. Once read, it's gone forever.</p>
        </div>

        <!-- Section 1: Upload Content -->
        <div class="bg-gray-700 p-6 rounded-xl">
            <h2 class="text-xl font-semibold mb-4">Leave a Message for a Stranger</h2>
            <textarea id="content-textarea" class="w-full h-28 bg-gray-800 border border-gray-600 rounded-lg p-3 text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Write something inspiring, a secret, or a kind thought..."></textarea>
            <button id="upload-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Send to the Void
            </button>
        </div>

        <!-- Section 2: Draw Content -->
        <div class="bg-gray-700 p-6 rounded-xl text-center">
            <h2 class="text-xl font-semibold mb-4">Your Lucky Draw</h2>
            <p class="text-gray-300 mb-2">You have</p>
            <div id="draw-count-display" class="text-6xl font-bold text-white mb-4">...</div>
            <p class="text-gray-300 mb-6">draws left today.</p>
            
            <button id="draw-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg text-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                Draw a Message
            </button>
        </div>

        <!-- User ID Display -->
        <div class="text-center">
            <p class="text-xs text-gray-500">Your Anonymous ID (for support): <span id="user-id-display">Loading...</span></p>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40">
        <div class="w-16 h-16 border-4 border-t-transparent border-indigo-500 rounded-full animate-spin"></div>
    </div>

    <!-- Custom Modal for Messages and Content -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeModal()">
        <div id="modal-content" class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-2xl font-semibold mb-4"></h3>
            <div id="modal-body" class="text-gray-300 whitespace-pre-wrap break-words"></div>
            <button id="modal-close-button" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Close
            </button>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            addDoc, 
            deleteDoc, 
            collection, 
            query, 
            where, 
            limit, 
            getDocs, 
            serverTimestamp,
            increment,
            documentId,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // This is my project's config from the Firebase console
        const firebaseConfig = {
            apiKey: "AIzaSyBxBnTHLioljBK0g3LBlrWtn2EFsCY9Pz8",
            authDomain: "lucky-draw-app-53625.firebaseapp.com",
            projectId: "lucky-draw-app-53625",
            storageBucket: "lucky-draw-app-53625.firebasestorage.app",
            messagingSenderId: "102850414969",
            appId: "1:102850414969:web:02af7869e0714d815687a8"
        };
        
        // --- Global Variables ---
        let app, auth, db, userId;
        let drawsLeft = 0;

        // --- DOM Elements ---
        const drawCountDisplay = document.getElementById('draw-count-display');
        const drawButton = document.getElementById('draw-button');
        const uploadButton = document.getElementById('upload-button');
        const contentTextarea = document.getElementById('content-textarea');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Modal Elements
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseButton = document.getElementById('modal-close-button');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            if (!firebaseConfig.apiKey) {
                showMessage("Firebase is not configured. The app will not work.", true);
                return;
            }
            
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Enable detailed Firestore logs

                // Wire up event listeners
                uploadButton.addEventListener('click', handleUpload);
                drawButton.addEventListener('click', handleDraw);
                modalCloseButton.addEventListener('click', closeModal);

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        await loadUserDrawStatus();
                    } else {
                        // User is signed out, attempt to sign in
                        await attemptSignIn();
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showMessage("Error initializing the app. See console for details.", true);
            }
        }

        async function attemptSignIn() {
            showLoading(true, "Authenticating...");
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Error signing in:", error);
                showMessage("Could not authenticate. Please refresh the page.", true);
            } finally {
                showLoading(false);
            }
        }

        // --- Core Logic Functions ---

        /**
         * Loads the user's draw status from Firestore or creates it if it's a new day.
         */
        async function loadUserDrawStatus() {
            if (!userId) return;

            showLoading(true, "Checking draws...");
            const today = new Date().toISOString().split('T')[0]; // 'YYYY-MM-DD'
            const userDrawDocRef = doc(db, 'artifacts', appId, 'users', userId, 'draws', 'dailyStats');
            
            try {
                const docSnap = await getDoc(userDrawDocRef);

                if (docSnap.exists() && docSnap.data().lastDrawDate === today) {
                    // User has played today, load their remaining draws
                    drawsLeft = docSnap.data().drawCount;
                } else {
                    // New day or new user, reset draws to 3
                    await setDoc(userDrawDocRef, {
                        drawCount: 3,
                        lastDrawDate: today
                    });
                    drawsLeft = 3;
                }
                updateDrawUI();
            } catch (error) {
                console.error("Error loading user draw status:", error);
                showMessage("Error loading your draw status. Please try again.", true);
            } finally {
                showLoading(false);
            }
        }

        /**
         * Handles the user uploading new content.
         */
        async function handleUpload() {
            const content = contentTextarea.value.trim();
            if (content.length === 0) {
                showMessage("Message can't be empty.", true);
                return;
            }

            showLoading(true, "Submitting...");
            try {
                // Store in the public collection
                const publicContentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'contents');
                await addDoc(publicContentsRef, {
                    content: content,
                    createdAt: serverTimestamp()
                });
                
                contentTextarea.value = '';
                showMessage("Your message has been sent to the void!", false);
            } catch (error) {
                console.error("Error uploading content:", error);
                showMessage("Could not submit your message. Please try again.", true);
            } finally {
                showLoading(false);
            }
        }

        /**
         * Handles the user drawing a random piece of content.
         */
        async function handleDraw() {
            if (drawsLeft <= 0) {
                showMessage("You have no draws left today. Come back tomorrow!", true);
                return;
            }

            showLoading(true, "Drawing...");
            
            try {
                // 1. Find a random document
                // This is the standard Firestore "get random doc" pattern
                const randomId = doc(collection(db, '...')).id; // Generate a random ID
                const publicContentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'contents');
                
                let docToBurn = null;

                // Try to find a doc >= the random ID
                const q1 = query(publicContentsRef, where(documentId(), '>=', randomId), limit(1));
                const snap1 = await getDocs(q1);

                if (!snap1.empty) {
                    docToBurn = snap1.docs[0];
                } else {
                    // If no doc found, try < the random ID (wraps around)
                    const q2 = query(publicContentsRef, where(documentId(), '<', randomId), limit(1));
                    const snap2 = await getDocs(q2);
                    if (!snap2.empty) {
                        docToBurn = snap2.docs[0];
                    }
                }

                if (docToBurn) {
                    // 2. We found a document. Get its content.
                    const content = docToBurn.data().content;

                    // 3. "Burn" the document (delete it)
                    await deleteDoc(docToBurn.ref);

                    // 4. Decrement the user's draw count
                    const userDrawDocRef = doc(db, 'artifacts', appId, 'users', userId, 'draws', 'dailyStats');
                    await updateDoc(userDrawDocRef, {
                        drawCount: increment(-1)
                    });
                    
                    drawsLeft--;
                    updateDrawUI();

                    // 5. Show the content
                    showContentModal(content);

                } else {
                    // No documents were found in the collection
                    showMessage("The void is empty... no messages to draw right now.", false);
                }

            } catch (error) {
                console.error("Error drawing content:", error);
                showMessage("An error occurred while drawing. Please try again.", true);
            } finally {
                showLoading(false);
            }
        }

        // --- UI Helper Functions ---

        /**
         * Updates the draw count display and button state.
         */
        function updateDrawUI() {
            drawCountDisplay.textContent = drawsLeft;
            if (drawsLeft <= 0) {
                drawButton.disabled = true;
                drawButton.textContent = "No Draws Left";
            } else {
                drawButton.disabled = false;
                drawButton.textContent = "Draw a Message";
            }
        }

        /**
         * Shows or hides the global loading spinner.
         */
        function showLoading(isLoading, message = "Loading...") {
            if (isLoading) {
                // You could add a message to the spinner if you want
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Shows a message in the custom modal.
         */
        function showMessage(message, isError = false) {
            modalTitle.textContent = isError ? "Oops!" : "Success!";
            modalBody.textContent = message;
            modalContent.classList.toggle('border-red-500', isError);
            modalContent.classList.toggle('border-green-500', !isError);
            modalBackdrop.classList.remove('hidden');
            document.body.classList.add('modal-open');
        }
        
        /**
         * Shows the drawn content in the custom modal.
         */
        function showContentModal(content) {
            modalTitle.textContent = "A Message from the Void";
            modalBody.textContent = content;
            modalContent.classList.remove('border-red-500', 'border-green-500');
            modalBackdrop.classList.remove('hidden');
            document.body.classList.add('modal-open');
        }

        /**
         * Closes the custom modal.
         */
        function closeModal() {
            modalBackdrop.classList.add('hidden');
            document.body.classList.remove('modal-open');
            // Clear content after closing
            setTimeout(() => {
                modalTitle.textContent = "";
                modalBody.textContent = "";
            }, 300);
        }

    </script>
</body>
</html>
